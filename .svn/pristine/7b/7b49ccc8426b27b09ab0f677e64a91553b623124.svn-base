<?php
namespace Home\Controller;
use Think\Controller;
class CoupunController extends CommonController {
    // 显示首页
  public function index(){

        //头部导航栏部分
       //一级分类
       $type = M("type");
       $nav1 = $type->where("pid = 0")->select();
       $this->assign("nav1",$nav1);
  
       $attach_type = M("attach_type");
       $nav2 = $attach_type->where("pid = 0")->select();
       $this->assign("nav2",$nav2);
       
      //头部导航栏
      $islogin = $_SESSION["username"]["islogin"];
      $uname = $_SESSION["username"]["uname"];
      $uid = $_SESSION["username"]["uid"];


      $this->assign("islogin",$islogin);
      $this->assign("uname",$uname);

      //优惠券
      $coupun = M("coupun");
      $res = $coupun->select();
      $this->assign("coupun",$res);

     //实例化优惠券详情表
      $coupun_detail = M("coupun_detail");
     //判断是否已经领取过
      $res3 = $coupun_detail->where("uid = ".$uid)->select();
      foreach($res3 as $v){
         $arr[] = $v["cid"];
      }

      $this->assign("arr",$arr);

      $this->display();
  }


  //领取优惠券操作
  public function gain(){
    
     $cid = I("get.id");
     $uid = $_SESSION["username"]["uid"];
    
     //实例化优惠券表
     $coupun = M("coupun");
     $result = $coupun ->where("id = ".$cid)->find();
     $data["cid"] = $cid;
     $data["uid"] = $uid;
     $data["remove_time"] = $result["remove_time"];
     $data["status"] = "0";

     //实例化优惠券详情表
     $coupun_detail = M("coupun_detail");
     //判断是否已经领取过
     $res = $coupun_detail->where("cid = ".$cid." and uid = ".$uid)->find();
     if($res){
        //如果已经领取过
        echo "1";
     }else{
        //如果还没有领取
       $res2 = $coupun_detail->data($data)->add();
       if($res2){
          //领取成功
          echo "2";
       }else{
          //领取失败
          echo "3";
       }
    }

  }


}