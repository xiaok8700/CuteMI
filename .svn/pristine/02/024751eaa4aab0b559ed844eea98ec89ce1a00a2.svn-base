<?php
namespace Admin\Controller;
use Think\Controller;
header("content-type:text/html;charset=utf-8");
class TypeController extends Controller {

    //显示首页
    public function index(){
        //显示分类信息
        $type = M("type");
        $res = $type->field("typeid,pid,tname,path,concat(path,typeid) as newpath")->order('newpath')->select();
        $this->assign("type",$res);
        $this->display();
    }
 

     public function add(){
            //通过超连接过去的
            if(I("get.typeid")){
                $typeid = I("get.typeid");
                $type = M("type");
                $res = $type->where("typeid=".$typeid)->find();
                $this->assign("pname",$res["tname"]); 
                $this->assign("typeid",$res["typeid"]);
            //直接访问时         
            }else{
                 $this->assign("pname","顶级");
            }
             $this->display();
    }


    public function doadd(){
      
        $type = M("type");
        //判断路径来源  
        if(I("post.typeid")){
          //从链接过来的
           $typeid = I("post.typeid");//父id
           $tname = I("post.tname");
         //拼装path字段(父path,父id);
           $result = $type->where("typeid=".$typeid)->find();
           $parentPath = $result["path"];
           $path = $parentPath.$typeid.",";
           
         //定义数据数组
           $res = $type->field("concat(path,typeid) as newpath")->where("typeid=".$typeid)->order('newpath')->find();
           $num = substr_count($res['newpath'],',');
          
           $data["tname"] = str_repeat("----",$num).$tname;
           $data["pid"] = $typeid;
           $data["path"] = $path;
            //dump($data);
           $res = $type->data($data)->add();
        }else{
            //直接添加的
            $type->create();
        	$res = $type->add();
             }
        
      //判断结果   
        if($res){
            $this->success("分类添加成功","index",3);
        }else{
            $this->error("分类添加失败","index",3);
        }

        }

     
        public function mod(){
            $this->display();
        }

































    public function del(){

         $type = M("type");
         $typeid = I("get.typeid");
         //取出所有的pid 
         $res = $type->field("pid")->select();
         foreach($res as $v){
            $pid[] = $v["pid"];
         }

         //判断是否为终极类
         if(in_array($typeid,$pid)){
            $this->error("对不起,该类下还有子类,不能删除",U("index"),3);
         }else{     
          $res = $type->where("typeid=".$typeid)->delete();

          if($res){
            $this->success("删除成功",U("index"),3);
          }else{
            $this->error("删除成功",U("index"),3);
          }
      }
    }


}